[background-color="#02303a"]
== Performance
image::gradle/bg-2.png[background, size=cover]

&#x1F680;


=== Performance
image::gradle/bg-2.png[background, size=cover]

image::xkcd-compiling.png[width=55%]

[.small]
https://xkcd.com/303


=== Performance
image::gradle/bg-2.png[background, size=cover]

image::monkeyuser-focus.png[width=30%]

[.small]
https://www.monkeyuser.com/2018/focus


=== Un build rapide c'est
image::gradle/bg-2.png[background, size=cover]

* moins de temps d'attente
* moins de changements de contexte
* plus de fluidité dans notre travail


=== Mesurer c'est douter
image::gradle/bg-2.png[background, size=cover]

[cols="<1,>1",frame=none,grid=none]
|===
a|* Mesurer
* Changer
* Mesurer
* Comparer

a|image::xkcd-optimizing.png[width=65%]

[.small]
https://xkcd.com/1691
|===


=== Build Scans
image::gradle/bg-2.png[background, size=cover]

> Un enregistrement permanent de ce qui se passe pendant un build.

TODO


=== `gradle-profiler`
image::gradle/bg-2.png[background, size=cover]

https://github.com/gradle/gradle-profiler

* benchmarking
* tracing & profiling
* TODO ...
* TODO link to example results, traces, flame graphs etc...


=== Construction incrémentale
image::gradle/bg-2.png[background, size=cover]

Rien ne sert de refaire une tâche déjà faite!

* up-to-date! inputs/outputs
** `UP_TO_DATE` à la deuxième exécution
* Compilation avoidance (API vs. ABI)
* Test d'incrémentalité
** Lancer un build
** Lancer un autre build sans faire de changement
** Si une tâche est réexécutée, on perds du temps !
*** Investiguer!

=== Cache de construction
image::gradle/bg-2.png[background, size=cover]

* L'activer : `--build-cache`, `org.gradle.caching=true`
* Vérifier : `FROM_CACHE` depuis un dossier différent
* Resources : https://docs.gradle.org/current/userguide/build_cache.html, especially  https://docs.gradle.org/current/userguide/build_cache_debugging.html and https://docs.gradle.org/current/userguide/common_caching_problems.html


=== Tâches incrémentales
image::gradle/bg-2.png[background, size=cover]

* Tâches incrémentales
** Gradle API https://docs.gradle.org/current/userguide/custom_tasks.html#incremental_tasks
** Support par plugin
** A considérer pour des tâches qui traitent plusieurs fichiers
** `gradle -i` pour comprendre ce qu'il se passe
* Java incremental annotation processing
** plugin/toolchain support
** how to check it works? do we emit a warning?


=== Construction parallèle
image::gradle/bg-2.png[background, size=cover]

* work : parallel safe vs. parallel unsafe
* max workers
* Exécution parallèle de tâches de projets différents
** `--parallel`
** `org.gradle.parallel=true`
** unsafe?
* Test forking


=== Résolution de dépendances
image::gradle/bg-2.png[background, size=cover]

* Versions dynamiques
* Déclarations de repositories


=== Résolution de dépendances
image::gradle/bg-2.png[background, size=cover]

Versions dynamiques

TODO


=== Résolution de dépendances
image::gradle/bg-2.png[background, size=cover]

Déclarations de repositories

* repo presence/order/filtering
* `mavenLocal()`
* TODO


=== Gestion de la mémoire
image::gradle/bg-2.png[background, size=cover]

* Processus Java: client, daemon, workers*
* Xmx anyone?
* TODO


// =====================================================================================================================


=== Nouvelles fonctionnalités
image::gradle/bg-2.png[background, size=cover]

[%step]
* *Configuration Cache* [_incubating_]
+
Cache le résultat de la configuration et du calcul du graphe de tâches, et réutilise pour les builds suivants.
* *Project Isolation* [_prototype_]
+
Étend le cache de configuration pour accélérer la phase configuration et la synchronisation depuis un IDE.


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Principes

* Cache le résultat de la configuration et du calcul du graphe de tâches, et réutilise pour les builds suivants.
* Détection des _inputs_ de la logique de build pour invalidation
* Tâches isolées du modèle de build mutable et entre elles


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Bénéfices

* Quand rien n'a changé, la configuration est complétement sautée
* Moins de pression mémoire car le modèle de build peut être garbage collecté
* Exécution de toutes les tâches en parallèle (incl. intra-projets)


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Contraintes sur la logique de configuration

* Environnement, fichiers de conf, process externes (e.g. `git`) etc...
* _Build listeners_ enregistrés lors de la configuration, notifiés lors de l'exécution
* link:https://docs.gradle.org/nightly/userguide/configuration_cache.html#config_cache:requirements[configuration_cache#requirements]


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Contraintes sur la logique d'exécution

* Pas de références au modèle de build dans les tâches +
e.g. `Project`, `Task` etc...
* Pas d'objets _live_ dans les _inputs_ +
e.g. `InputStream`, `Socket` etc...
* link:https://docs.gradle.org/nightly/userguide/configuration_cache.html#config_cache:requirements[configuration_cache#requirements]


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

* Force les bonnes pratiques
** Claire séparation entre configuration et execution
** Déclaration correcte des _inputs_
** Pas d'interdépendance entre instances de tâches


[background-color="#02303a"]
=== Démo
image::gradle/bg-2.png[background, size=cover]

[.notes]
--
Utiliser `gradle/gradle`
Execution des tests
Adoption progressive
Exemple d'une task a fixer, ptet dans un autre build plus simple, celui de la doc
--


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

* Les plugins Core JVM sont compatibles
** tous les autres ne le sont pas encore [link:https://docs.gradle.org/nightly/userguide/configuration_cache.html#config_cache:plugins:core[doc]]
* Les plugins Kotlin et Android sont compatibles
* De plus en plus de plugins communautaires sont compatibles link:https://github.com/gradle/gradle/issues/13490[gradle/gradle#13490]


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Feuille de route, à ce jour

* [.line-through]#incubating# => stable dans Gradle 8.x +
  (en opt-in)
* Activé par défaut dans Gradle 9.0 +
  (avec un opt-out)
* Seul mode possible dans Gradle x.x +
  (sans opt-out)

=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

* Cache le résultat de la configuration et du calcul du graphe de tâches, et réutilise pour les builds suivants.
* Le jeu en vaut la chandelle
* Vous pouvez démarrer son adoption aujourd'hui


// =====================================================================================================================


=== Project Isolation
image::gradle/bg-2.png[background, size=cover]

Principes

* Étend le cache de configuration pour accélérer la phase configuration et la synchronisation depuis un IDE.
* Isole les projets les uns des autres


=== Project Isolation
image::gradle/bg-2.png[background, size=cover]

Bénéfices

* *Synchronization IDE plus rapide*
** Cache de modèles TAPI pour les IDE
* *Phase de configuration plus rapide*
** Cache de configuration par projet
** Configuration parallèle


=== Project Isolation
image::gradle/bg-2.png[background, size=cover]

Contraintes

* Ne pas référencer un `Project` depuis un autre
* Configuration avec `subprojects {}` & `allprojects {}`
** Utiliser des plugins de convention
* Consommer les _outputs_ d'un projet dans un autre
** Utiliser les publications et les dépendances


=== Project Isolation
image::gradle/bg-2.png[background, size=cover]

État d'avancement

[.small]
--
* Actuellement au stade de prototype
* Activable aujourd'hui
** dégrade les performances si les contraintes sont violées
** l'accéleration de la synchronization IDE ne fonctionne pas encore
** l'accéleration de la phase de configuration n'est pas implémentée
--


// =====================================================================================================================


=== Performance
image::gradle/bg-2.png[background, size=cover]

[cols="<1,>1",frame=none,grid=none]
|===
a|* Mesurer
* Changer
* Mesurer
* Comparer

a|image::xkcd-optimizing.png[width=65%]

[.small]
https://xkcd.com/1691
|===
