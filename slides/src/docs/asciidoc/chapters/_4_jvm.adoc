[background-color="#02303a"]
== Fonctionnalités JVM
image::gradle/bg-6.png[background, size=cover]

&#x2615;

=== Catalogue de versions
image::gradle/bg-6.png[background, size=cover]

[%step]
* Centralisation de la liste des dépendances
[%step]
** Leurs coordonnées et version, y compris riche
** Pas de classifier, exclude ou autres attributs
* Fourni des accesseurs typés
* Possibilité de séparer la version du `group:artifact`
* Permet de déclarer des groupes de dépendances

[background-color="#02303a"]
=== Démo
image::gradle/bg-6.png[background, size=cover]

[.notes]
--
* Montrer un projet simple
* Contenu du catalogue
** Dépendances
** Versions
* Utilisation du catalogue dans le projet
* Import d'un catalogue
--

=== Format TOML
image::gradle/bg-6.png[background, size=cover]

[source,toml]
----
[versions]
groovy = "4.0.1"
lang = { strictly = "[3.8, 4.0[", prefer="3.9" } }

[libraries]
groovy-core = { module = "org.apache.groovy:groovy", version.ref = "groovy" }
groovy-json = { module = "org.apache.groovy:groovy-json", version.ref = "groovy" }
commons-lang3 = { group = "org.apache.commons", name = "commons-lang3", version.ref = "lang" }

[bundles]
groovy = ["groovy-core", "groovy-json", "groovy-nio"]

[plugins]
logging-capabilities = { id = "dev.jacomet.logging-capabilities", version = "0.10.0" }
----

* Il existe aussi une API dans le fichier `settings` de Gradle.

=== Points d'attention
image::gradle/bg-6.png[background, size=cover]

* Participe à la résolution de dépendances de façon classique
** N'impose pas une version
* Possibilité de publier et d'importer un catalogue
* Pas accessible pour un plugin de settings ou un script d'initialisation

=== Java Toolchains
image::gradle/bg-6.png[background, size=cover]

[%step]
* Permet de séparer le Java qui tourne Gradle de celui requis par le projet
* Application pour la compilation, les tests et l'exécution
* Permet de choisir avec les critères suivants :
[%step]
** Version du langage Java
** Vendeur de la JVM
** (Implémentation : défaut ou J9)

[background-color="#02303a"]
=== Démo
image::gradle/bg-6.png[background, size=cover]

[.notes]
--
* Configuration dans `java`
* Configuration pour une tâche spécifique
* Tâche `javaToolchains`
--

=== Quel Java Gradle connait-il?
image::gradle/bg-6.png[background, size=cover]

* Un certain nombre de défauts
[%step]
** Par OS: Linux, macOS, Windows
** Package managers: Asdf-vm, Jabba, SDKMAN!
** Maven toolchains
** Téléchargements précédents

=== Provisioner Java
image::gradle/bg-6.png[background, size=cover]

[%step]
* Possible grâce à AdoptOpenJDK
* Mais pas idéal, suite à la migration Adoptium
* Micmac avec le vendeur

=== Futur
image::gradle/bg-6.png[background, size=cover]

[%step]
* SPI pour créer des plugins de provisionnement
* Plus d'options pour sélectionner sa JVM
** GraalVM, version plus précise, early access, ...
* Plus de tâches qui les supportent
** Dans Gradle : analyse de code par exemple
** Dans les plugins de la communauté, demandez le support!

[.notes]
--
* Par exemple support toolchain dans Checkstyle pour Gradle 7.5
--

=== Les suites de tests
image::gradle/bg-6.png[background, size=cover]

[%step]
* Modélise une collection de tests
* Permet une séparation logique des tests au niveau des sources et dépendances
* Le défaut de Gradle, `test`, est maintenant dérivé de ce modèle

[background-color="#02303a"]
=== Démo
image::gradle/bg-6.png[background, size=cover]

[.notes]
--
* Ajout d'une suite de tests
* Configuration du test type
* Dépendances
* Configuration des tâches
* Lien avec tâche `build`
--

=== Evolution des suites de tests
image::gradle/bg-6.png[background, size=cover]

* Possibilité d'avoir plusieurs dimensions
** Différentes versions de Java pour tourner les tests
** Se traduira par plusieurs tâches de `Test`
* Intégration avec la couverture de code
** Nécessite d'interagir avec la tâche actuellement

=== Test fixtures
image::gradle/bg-6.png[background, size=cover]

* Permet de séparer les fixtures du code de test
* Permet de consommer les fixtures d'une librairie
* Illustration du modèle avancé de gestion de dépendances de Gradle

[background-color="#02303a"]
=== Démo
image::gradle/bg-8.png[background, size=cover]

[.notes]
--
* Ajout de fixtures
* Code simple et utilisation dans un test
* Consommation
--

=== Modélisation des tests fixtures
image::gradle/bg-6.png[background, size=cover]

* Comme les suites de test : sources et dépendances séparées
* Publiées de façon complètes
** Comme une variante dans Gradle Module Metadata
** Avec un `classifier` pour utilisation dans Maven / Ivy

[.notes]
--
* Exemple de cette notion de variante dans la gestion de dépendances
--

=== Gestion de dépendances : les variantes
image::gradle/bg-6.png[background, size=cover]

* Dimension supplémentaire d'un composant logiciel
* Peut avoir ses propres artifacts et dépendances
* Pensez `classifier`, sans les limitations
* Nécessite Gradle Module Metadata

=== Autre exemple : Dépendances optionelles
image::gradle/bg-6.png[background, size=cover]

[%step]
* Possibilité de définir une variante qui
[%step]
** Dépend du composant principal
** Ajoute des dépendances
** Peut aussi ajouter un binaire
* Qui en fait ne sont pas du tout optionelles ...
* Mais bien obligatoires pour certains cas d'utilisation

=== Exemple

[cols="<.^1",frame=none,grid=none]
|===
a|
.`producer.gradle.kts`
[source,kotlin]
----
java {
    registerFeature("mysqlSupport") {
        usingSourceSet(sourceSets["main"])
    }
    registerFeature("mongodbSupport") {
        usingSourceSet(sourceSets["main"])
    }
}

dependencies {
    "mysqlSupportImplementation"("mysql:mysql-connector-java:8.0.14")
    "mongodbSupportImplementation"("org.mongodb:mongodb-driver-sync:3.9.1")
}
----
.`consumer.gradle.kts`
[source,kotlin]
----
dependencies {
    implementation(project(":producer"))

    // On ajoute la variant MySQL
    runtimeOnly(project(":producer")) {
        capabilities {
            requireCapability("org.gradle.demo:producer-mysql-support")
        }
    }
}
----
|===


=== Applications du modèle des variantes
image::gradle/bg-6.png[background, size=cover]

* Test fixtures
* Fonctionalités optionelles
* Aggregation de résultats entre projets
* (Transformation d'artifacts)

=== Publication
image::gradle/bg-6.png[background, size=cover]

* Que publie-t-on ?
** Un composant
** Ses variantes
** Ses meta données
* Où le publie-t-on ?
** Dans un repository Maven ou Ivy
* Comment publier ?

[background-color="#02303a"]
=== Démo
image::gradle/bg-8.png[background, size=cover]

[.notes]
--
* Ajout du plugin
* Configuration, y compris POM
* Repository
* Variante?
--

=== Que publier ?
image::gradle/bg-6.png[background, size=cover]

* Le composant
** `java` pour les plugins Java
* Modifiez le composant plutôt que la publicationn
** Un artifact additionel ?
** Définissez une variante

=== Méta données
image::gradle/bg-6.png[background, size=cover]

* Pas possible de manipuler les GMM avec un API
* Toute mutation de POM avec `withXml` va entrainer des différences
* Comme pour les artifacts, modifiez le composant!

=== Astuces de publication

* Valider une publication:
** publier sur un repository local
* Dépendances : versions déclarées ou résolues ?
* Publier sur Maven Central
** https://plugins.gradle.org/plugin/io.github.gradle-nexus.publish-plugin[Utilisez `io.github.gradle-nexus.publish-plugin`]

=== Besoins pour les composants JVM

* Gradle fournit un certain nombre de choses
* Mais tout n'est pas couvert
* Qu'est-ce qu'il vous manque en pratique?
** Pensez à le demander ici ou sur https://github.com/gradle/gradle/issues/new?assignees=&labels=a%3Afeature%2C+to-triage&template=contributor_feature_request.md&title=[GitHub]