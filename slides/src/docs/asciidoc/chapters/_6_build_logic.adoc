[background-color="#02303a"]
== Logique de build
image::gradle/bg-11.png[background, size=cover]

&#x1F9F0;


=== Langages d'implémentation
image::gradle/bg-11.png[background, size=cover]

include::../fragments/_diagram_build-logic-parts.adoc[]


=== Idiomatisme
image::gradle/bg-11.png[background, size=cover]

Scripts du build vs. Plugins

* Les scripts du build sont déclaratifs
* Les plugins locaux au build implémentent la logique de configuration du build
* La logique de build utilise des plugins externes


=== Modèle de programmation
image::gradle/bg-11.png[background, size=cover]

[cols="<.^7,<.^3",frame=none,grid=none]
|===
a|
[.small]
--
* Don't call us, we'll call you! +
_Sugarloaf^WHollywood_
* Types abstraits, instanciés et décorés par Gradle
* Services Gradle injectés
--
a|
.`build.gradle`
[source,groovy]
----
abstract class Something {

    @Inject
    abstract ExecOperations getExecOps()

    abstract Property<String> getSomeProperty()

    def someAction() {
        execOps.exec {
            commandLine "git", "status"
        }
        println someProperty.get()
    }
}

objects.newInstance(Something)
----
|===


=== Beans ?
image::gradle/bg-11.png[background, size=cover]

* Oui et non ... JavaBeans + `Property<T>`
* JavaBeans pour l'interop avec Groovy et Kotlin
* `Property<T>` est un conteneur de valeur +
  `Provider<T>` est son pendant immutable
** associe une propriété à ses dépendances dans le build
** permet un chaînage _lazy_ des propriétés


=== Blocs de construction
image::gradle/bg-11.png[background, size=cover]

[cols="<.^1,^.^2",frame=none,grid=none]
|===
a|
* Plugins
* Extensions de DSL
* Tâches

a|
include::../fragments/_diagram_how-it-works.adoc[]
|===


=== Phases d'un build
image::gradle/bg-11.png[background, size=cover]

* *Configuration* +
  Plugins + DSL = enregistrement des tâches
* *Calcul du graphe de tâches* +
  Gradle
* *Execution du travail* +
  Dépendances de tâches, incrémentalité


=== Plugins
image::gradle/bg-11.png[background, size=cover]

[cols="<.^3,<.^4",frame=none,grid=none]
|===
a|
* Cibles de plugin
** `Project`
** `Settings`
** `Gradle`

a|
* Equivalences en scripts
** _project script_
** _settings script_
** _init script_
|===

.`MyPlugin.java`
[source,java]
----
class MyPlugin implements Plugin<Project> {
    @Override
    public void apply(Project project) {
        /* ... Utilisation de l'API Gradle ... */
    }
}
----


=== Scripts de plugin précompilés
image::gradle/bg-11.png[background, size=cover]

* aka. Precompiled Script Plugins
* Plugins écrits avec le DSL gradle
* Placés dans un `SourceSet`

[source]
----
src/main/kotlin/my-plugin.gradle.kts
src/main/kotlin/my-plugin.settings.gradle.kts
src/main/groovy/my-plugin.init.gradle
----


=== Étendre le DSL
image::gradle/bg-11.png[background, size=cover]

Extensions : objets nommés +
enregistrés sur `Settings` ou `Project`

[cols="<.^1,<.^1",frame=none,grid=none]
|===
a|
.`MyExtension.kt`
[source,kotlin]
----
interface MyExtension {

    var someProperty: Property<Int>

    var someDirectory: DirectoryProperty

    fun someFunction(parameter:String)
}
----
.`my-plugin.gradle.kts`
[source,kotlin]
----
extensions.create<MyExtension>("myExtension")
----
a|
.`build.gradle`
[source,groovy]
----
plugins {
    id("my-plugin")
}

myExtension {
    someProperty = 42
    someDirectory = layout.buildDirectory.dir("pa/th")
    someFunction("parameter")
}
----
|===


[background-color="#02303a"]
=== Démo
image::gradle/bg-11.png[background, size=cover]

[.notes]
--
Montrer le plugin de démo, son extension DSL
--

// =====================================================================================================================


=== Écrire des tâches
image::gradle/bg-11.png[background, size=cover]

Les tâches sont des fonctions

[cols="<.^3,>.^2",frame=none,grid=none]
|===
a|
[.small]
--
* Que sont les _input_ de la tâche ?
* Que sont les _outputs_ de la tâche ?
* Que se passe-t-il +
  quand l'un d'eux change ?
--

a|
include::../fragments/_diagram_task-execution.adoc[]
|===


=== Écrire des tâches
image::gradle/bg-11.png[background, size=cover]

[cols="<.^1,<.^1",frame=none,grid=none]
|===
a|
Exécutée à chaque fois

.`MyTask.kt`
[source,kotlin]
----
abstract class MyTask : DefaultTask() {

  abstract val inputs: ConfigurableFileTree

  abstract val output: DirectoryProperty

  @TaskAction
  fun action() {
    /* ... */
  }
}
----
a|
`UP-TO-DATE`

.`MyTask.kt`
[source,kotlin]
----
abstract class MyTask : DefaultTask() {

  @get:InputFiles <1>
  abstract val inputs: ConfigurableFileTree

  @get:OutputDirectory <2>
  abstract val output: DirectoryProperty

  @TaskAction
  fun action() {
    /* ... */
  }
}
----
<1> Déclare cette propriété comme un _input_
<2> Déclare cette propriété comme un _output_
|===


=== Tâches mises en cache
image::gradle/bg-11.png[background, size=cover]

[source,kotlin]
----
@CacheableTask <1>
abstract class MyTask : DefaultTask() {

  @get:InputFiles
  @get:PathSensitive(RELATIVE) <2>
  abstract val inputs: ConfigurableFileCollection

  @get:OutputDirectory
  abstract val output: DirectoryProperty

  @TaskAction
  fun action() {
    /* ... */
  }
}
----
<1> Marque la tâche comme _cacheable_
<2> Définit la sensibilité des chemins pour cet _input_

=== _Inputs_ de tâches incrémentaux
image::gradle/bg-11.png[background, size=cover]

[.small]
--
* `fun action(inputChanges: InputChanges)`
** Savez précisemment _quels_ fichiers ont changé
** L'action de tâche peut alors faire le minimum de travail
* Usage typique : tâche qui produit un fichier _output_ par fichier _input_
* Usage avancé : compilation
--


[background-color="#02303a"]
=== Démo
image::gradle/bg-11.png[background, size=cover]

[.notes]
--
Montrer les tâches du plugin de demo
TRANSITION: tout ça c'est du code, et le code ça se teste
--

// =====================================================================================================================


=== Injection de services
image::gradle/bg-11.png[background, size=cover]

* TODO


=== Build services
image::gradle/bg-11.png[background, size=cover]

_ Services de build partagés ou _shared build services_
* TODO


// =====================================================================================================================


=== Tester c'est douter
image::gradle/bg-11.png[background, size=cover]

[cols="<.^1,^.^1",frame=none,grid=none]
|===
a|
* Tests unitaires +
`ProjectBuilder` [link:https://docs.gradle.org/current/javadoc/org/gradle/testfixtures/ProjectBuilder.html[doc]]
* Tests d'intégration +
`Gradle TestKit` [link:https://docs.gradle.org/current/userguide/test_kit.html[doc]]

a|
image::tester-cest-douter.jpeg[]
|===


=== Tests unitaires
image::gradle/bg-11.png[background, size=cover]

* `ProjectBuilder`
* Pour tester les interactions avec le modèle de configuration
* Seulement sur `Project`
* Pas pour tester les tâches


=== Tests d'intégration
image::gradle/bg-11.png[background, size=cover]

* `Gradle TestKit`
* Pour tester des builds complets
* Fais tourner un vrai Gradle
* Expose la sortie de Gradle pour assertions
* Expose les résultats de tâches pour assertions


[background-color="#02303a"]
=== Démo
image::gradle/bg-11.png[background, size=cover]

[.notes]
--
Montrer et expliquer les tests du plugin de démo
--

// =====================================================================================================================


=== Gradle TestKit
image::gradle/bg-11.png[background, size=cover]

* Comment tester des scénarios et lesquels sont importants
* Tester plusieurs versions de Gradle
* TODO
